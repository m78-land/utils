{"version":3,"sources":["/Users/lixianjie/project/openSource/utils/src/function.ts"],"sourcesContent":["/**\n * 将一个错误优先且回调位于最后一个参数的node风格的callback函数转为Promise return函数\n * @param fn - 要包装的函数\n * @param {object} receiver - 要绑定作用域的对象\n * @return promise - 转换后的函数\n */\nimport { AnyFunction, EmptyFunction } from \"./common-type.js\";\n\nexport function promisify<T = any>(\n  fn: AnyFunction,\n  receiver?: object\n): (...args: Parameters<AnyFunction>) => Promise<T> {\n  return (...args) => {\n    return new Promise<T>((resolve, reject) => {\n      fn.apply(receiver, [\n        ...args,\n        (err, res) => {\n          return err ? reject(err) : resolve(res);\n        },\n      ]);\n    });\n  };\n}\n\n/**\n * 返回一个延迟指定时间的Promise\n * @param ms - 延迟时间\n * @param payload - 将要resolve的任意值，如果是Error对象，则promise会抛出异常\n * @return - Promise\n * */\nexport function delay<T = any>(\n  ms: number,\n  payload?: T\n): Promise<T extends Error ? void : T> {\n  return new Promise((res, rej) => {\n    setTimeout(\n      () => (payload instanceof Error ? rej(payload) : res(payload as any)),\n      ms\n    );\n  });\n}\n\n/** 接收任意参数并返回, 用例是作为一个无效接收器或默认参数使用 */\nexport const dumpFn = (...arg: any[]): any => arg;\n\n/** 延迟执行一个函数 */\nexport const defer = (fn: AnyFunction, ...args: any[]): any =>\n  setTimeout(fn, 1, ...args);\n\nconst defaultConfig = {\n  rate: 0.2,\n};\n\n/** retry函数的配置 */\nexport interface FunctionReTryConfig {\n  maxDelay?: number;\n  rate?: number;\n  fixed?: boolean;\n  maxRetry?: number;\n}\n\n/**\n * 执行一次handle，如果handle\n * @param handle - 处理函数，调用retry时会立即执行一次，如果handle执行返回了truthy值，则会在下一延迟执行点重新执行handle\n * @param delay - 进行重试间隔的毫秒，默认情况下，每次执行的间隔会通过边际递增算法增加, 可以通过config.fixed取消此行为\n * @param config - 配置\n * @param config.maxDelay - 重试延迟的最大延迟\n * @param config.rate - 0.2 | 递增比，此比例越大，则重试的频率越小\n * @param config.fixed - 不使用边际递增算法，固定重试时间\n * @param config.maxRetry - 最大重复次数\n * @return clear() - 用于停止重试并清理内部计时器\n * */\nexport function retry(\n  handle: () => any,\n  delay: number,\n  config?: FunctionReTryConfig\n): EmptyFunction {\n  const { maxDelay, rate, fixed, maxRetry } = { ...defaultConfig, ...config };\n\n  let t;\n  const clear = () => t && clearTimeout(t);\n\n  const res = handle();\n  if (!res) return clear;\n\n  let d = delay;\n  let count = 1;\n\n  const trigger = () => {\n    t = setTimeout(() => {\n      if (handle()) {\n        if (maxRetry && maxRetry === count) return;\n        if (!fixed) {\n          const nextD = count * rate * delay + d;\n          d = maxDelay ? Math.min(nextD, maxDelay) : nextD;\n        }\n        count++;\n        trigger();\n      }\n    }, d);\n  };\n\n  trigger();\n\n  return clear;\n}\n\n// TODO: 增加异步版本 asyncRetry\n\n/** 以统一格式抛出错误 */\nexport function throwError(msg: string, prefix?: string | undefined): never {\n  throw new Error(`${prefix ? `${prefix}::` : \"\"}ERROR: ${msg}`);\n}\n\n/** 以统一格式抛出警告 */\nexport function throwWarning(msg: string, prefix?: string | undefined): void {\n  console.warn(`${prefix ? `${prefix}::` : \"\"}WARNING: ${msg}`);\n}\n"],"names":["promisify","delay","dumpFn","defer","retry","throwError","throwWarning","fn","receiver","args","Promise","resolve","reject","apply","err","res","ms","payload","rej","setTimeout","Error","arg","defaultConfig","rate","handle","config","maxDelay","fixed","maxRetry","t","clear","clearTimeout","d","count","trigger","nextD","Math","min","msg","prefix","console","warn"],"mappings":"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"}